name: "Admissibility Witness"
description: "Run admit ci and emit witnessed CI summary."

inputs:
  mode:
    description: "CI mode: observe|audit|enforce"
    required: false
    default: "enforce"
  config-path:
    description: "Optional path to .admit/config.toml"
    required: false
    default: ""
  require-github:
    description: "Require github.ceremony scope availability"
    required: false
    default: "true"
  plan-path:
    description: "Plan artifact path (required when plan-rollout=enforce)"
    required: false
    default: ".admit/plan/plan-artifact.json"
  manifest-path:
    description: "Proposal manifest path (required when plan-rollout=enforce)"
    required: false
    default: ".admit/plan/proposal-manifest.json"
  plan-rollout:
    description: "Plan contract rollout: advisory|enforce"
    required: false
    default: "enforce"
  scope-pack-gate:
    description: "Scope pack gate mode: warn|error"
    required: false
    default: "error"
  comment:
    description: "Post PR comment via gh when possible"
    required: false
    default: "false"

outputs:
  verdict:
    description: "Witness verdict"
    value: ${{ steps.parse.outputs.verdict }}
  witness-hash:
    description: "Witness canonical hash"
    value: ${{ steps.parse.outputs.witness_hash }}
  witness-path:
    description: "Witness artifact path"
    value: ${{ steps.parse.outputs.witness_path }}
  requires-manual-approval:
    description: "Whether plan contract requires manual approval"
    value: ${{ steps.parse.outputs.requires_manual_approval }}
  plan-valid:
    description: "Whether plan artifact validated successfully"
    value: ${{ steps.parse.outputs.plan_valid }}

runs:
  using: "composite"
  steps:
    - name: Ensure admit CLI binary
      shell: bash
      run: |
        if [ -x target/debug/admit_cli ]; then
          echo "using existing target/debug/admit_cli"
          exit 0
        fi
        cargo build -p admit_cli

    - name: Autogenerate plan artifacts when required
      shell: bash
      run: |
        ADMIT_BIN="target/debug/admit_cli"
        PLAN_PATH="${{ inputs.plan-path }}"
        MANIFEST_PATH="${{ inputs.manifest-path }}"
        PLAN_ROLLOUT="${{ inputs.plan-rollout }}"

        if [ "$PLAN_ROLLOUT" != "enforce" ]; then
          exit 0
        fi

        NEED_AUTOGEN=0
        if [ -n "$PLAN_PATH" ] && [ ! -f "$PLAN_PATH" ]; then
          NEED_AUTOGEN=1
        fi
        if [ -n "$MANIFEST_PATH" ] && [ ! -f "$MANIFEST_PATH" ]; then
          NEED_AUTOGEN=1
        fi

        if [ "$NEED_AUTOGEN" -eq 0 ]; then
          exit 0
        fi

        AUTOGEN_ARGS=(plan autogen --root .)
        BASE_SHA=""
        HEAD_SHA=""
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        elif [ "${{ github.event_name }}" = "push" ]; then
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
        fi

        if [ -n "$BASE_SHA" ] && [ "$BASE_SHA" != "0000000000000000000000000000000000000000" ]; then
          AUTOGEN_ARGS+=(--base-sha "$BASE_SHA")
        fi
        if [ -n "$HEAD_SHA" ]; then
          AUTOGEN_ARGS+=(--head-sha "$HEAD_SHA")
        fi

        if [ -n "$PLAN_PATH" ]; then
          AUTOGEN_ARGS+=(--out-plan "$PLAN_PATH")
        fi
        if [ -n "$MANIFEST_PATH" ]; then
          AUTOGEN_ARGS+=(--out-manifest "$MANIFEST_PATH")
        fi

        "$ADMIT_BIN" "${AUTOGEN_ARGS[@]}"

    - name: Run admissibility witness
      id: run_witness
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        GITHUB_TOKEN: ${{ github.token }}
        GH_PR_NUMBER: ${{ github.event.pull_request.number }}
        GH_REPO: ${{ github.repository }}
      run: |
        mkdir -p out/artifacts
        ADMIT_BIN="target/debug/admit_cli"
        CONFIG_ARG=""
        if [ -n "${{ inputs.config-path }}" ]; then
          CONFIG_ARG="--config ${{ inputs.config-path }}"
        fi
        REQUIRE_GH_ARG=""
        if [ "${{ inputs.require-github }}" = "true" ]; then
          REQUIRE_GH_ARG="--require-github"
        fi
        PLAN_ARG=""
        if [ -n "${{ inputs.plan-path }}" ]; then
          PLAN_ARG="--plan ${{ inputs.plan-path }}"
        fi
        MANIFEST_ARG=""
        if [ -n "${{ inputs.manifest-path }}" ]; then
          MANIFEST_ARG="--manifest ${{ inputs.manifest-path }}"
        fi
        set +e
        $ADMIT_BIN ci --root . --mode "${{ inputs.mode }}" --json --artifacts-dir out/artifacts --plan-rollout "${{ inputs.plan-rollout }}" --scope-pack-gate "${{ inputs.scope-pack-gate }}" $PLAN_ARG $MANIFEST_ARG $CONFIG_ARG $REQUIRE_GH_ARG > out/ci-witness.json 2> out/ci-witness.stderr
        CI_EXIT=$?
        set -e
        echo "ci_exit_code=$CI_EXIT" >> "$GITHUB_OUTPUT"
        if [ ! -s out/ci-witness.json ]; then
          jq -n --arg err "$(cat out/ci-witness.stderr)" '{
            mode: "unknown",
            verdict: "error",
            integrity_failures: [],
            stop_reasons: [],
            top_warnings: [],
            scope_warnings: [],
            requires_manual_approval: false,
            error: $err
          }' > out/ci-witness.json
        fi

    - name: Parse outputs
      id: parse
      shell: bash
      run: |
        VERDICT=$(jq -r '.verdict // ""' out/ci-witness.json)
        WITNESS_HASH=$(jq -r '.witness_hash // ""' out/ci-witness.json)
        WITNESS_PATH=$(jq -r '.witness_artifact_path // ""' out/ci-witness.json)
        REQUIRES_MANUAL_APPROVAL=$(jq -r '.requires_manual_approval // false' out/ci-witness.json)
        PLAN_VALID=$(jq -r '.plan_contract.plan_valid // false' out/ci-witness.json)
        echo "verdict=$VERDICT" >> "$GITHUB_OUTPUT"
        echo "witness_hash=$WITNESS_HASH" >> "$GITHUB_OUTPUT"
        echo "witness_path=$WITNESS_PATH" >> "$GITHUB_OUTPUT"
        echo "requires_manual_approval=$REQUIRES_MANUAL_APPROVAL" >> "$GITHUB_OUTPUT"
        echo "plan_valid=$PLAN_VALID" >> "$GITHUB_OUTPUT"

    - name: Publish summary
      shell: bash
      run: |
        echo "## Admissibility Witness" >> "$GITHUB_STEP_SUMMARY"
        echo '```json' >> "$GITHUB_STEP_SUMMARY"
        jq . out/ci-witness.json >> "$GITHUB_STEP_SUMMARY" || cat out/ci-witness.json >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"

    - name: Build PR comment body
      if: ${{ inputs.comment == 'true' }}
      shell: bash
      run: |
        VERDICT=$(jq -r '.verdict // "unknown"' out/ci-witness.json)
        MODE=$(jq -r '.mode // "unknown"' out/ci-witness.json)
        FAIL_THRESHOLD=$(jq -r '.fail_threshold // "unknown"' out/ci-witness.json)
        WITNESS_HASH=$(jq -r '.witness_hash // ""' out/ci-witness.json)
        WITNESS_PATH=$(jq -r '.witness_artifact_path // ""' out/ci-witness.json)
        INTEGRITY_COUNT=$(jq -r '(.integrity_failures // []) | length' out/ci-witness.json)
        SCOPE_WARNING_COUNT=$(jq -r '(.scope_warnings // []) | length' out/ci-witness.json)
        PLAN_VALID=$(jq -r '.plan_contract.plan_valid // false' out/ci-witness.json)
        MANIFEST_VALID=$(jq -r '.plan_contract.manifest_valid // false' out/ci-witness.json)
        MANUAL_APPROVAL=$(jq -r '.requires_manual_approval // false' out/ci-witness.json)
        STOP_REASON_COUNT=$(jq -r '(.stop_reasons // []) | length' out/ci-witness.json)

        cat > out/ci-witness-comment.md <<EOF
        <!-- admit-ci-witness -->
        ## Admissibility Witness

        | key | value |
        | --- | --- |
        | mode | \`$MODE\` |
        | verdict | \`$VERDICT\` |
        | fail_threshold | \`$FAIL_THRESHOLD\` |
        | witness_hash | \`$WITNESS_HASH\` |
        | witness_artifact_path | \`$WITNESS_PATH\` |
        | integrity_failures | \`$INTEGRITY_COUNT\` |
        | scope_warnings | \`$SCOPE_WARNING_COUNT\` |
        | plan_valid | \`$PLAN_VALID\` |
        | manifest_valid | \`$MANIFEST_VALID\` |
        | requires_manual_approval | \`$MANUAL_APPROVAL\` |
        | stop_reasons | \`$STOP_REASON_COUNT\` |

        <details>
        <summary>Full Witness Summary (JSON)</summary>

        \`\`\`json
        $(jq . out/ci-witness.json)
        \`\`\`
        </details>
        EOF

    - name: Best-effort PR comment
      if: ${{ inputs.comment == 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        if [ -n "$PR_NUMBER" ]; then
          REPO="${{ github.repository }}"
          MARKER="<!-- admit-ci-witness -->"
          EXISTING_ID=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --paginate --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | contains(\"$MARKER\"))) | .id" | tail -n 1)

          if [ -n "$EXISTING_ID" ]; then
            gh api --method PATCH "repos/$REPO/issues/comments/$EXISTING_ID" -f body="$(cat out/ci-witness-comment.md)" || true
          else
            gh api --method POST "repos/$REPO/issues/$PR_NUMBER/comments" -f body="$(cat out/ci-witness-comment.md)" || true
          fi
        fi

    - name: Enforce witness result
      if: ${{ steps.run_witness.outputs.ci_exit_code != '0' }}
      shell: bash
      run: |
        echo "admit ci failed (exit=${{ steps.run_witness.outputs.ci_exit_code }})"
        exit "${{ steps.run_witness.outputs.ci_exit_code }}"
